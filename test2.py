# -*- coding: utf-8 -*-
"""test2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Zxn8MjMskHlpwKngunVj_fOLk02KAvAL
"""

# -*- coding: utf-8 -*-
import streamlit as st
import os
import json
from datetime import datetime

# ========== åˆæœŸè¨­å®š ==========
USER_FILE = "users.json"
LOG_DIR = "logs"
os.makedirs(LOG_DIR, exist_ok=True)

# ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ==========
def load_users():
    if os.path.exists(USER_FILE):
        with open(USER_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_users(users):
    with open(USER_FILE, "w", encoding="utf-8") as f:
        json.dump(users, f, indent=2, ensure_ascii=False)

# ========== ãƒ­ã‚°è¨˜éŒ² ==========
def write_log(message):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log_path = os.path.join(LOG_DIR, "IDlogin.txt")
    with open(log_path, "a", encoding="utf-8") as f:
        f.write(f"[{now}] {message}\n")

# ========== ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ ==========
if "page" not in st.session_state:
    st.session_state.page = "login"
if "user_id" not in st.session_state:
    st.session_state.user_id = None

users = load_users()

def login_page():
    st.title("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸")

    id_input = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", key="login_id_input")
    pw_input = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password", key="login_pw_input")

    if st.button("ãƒ­ã‚°ã‚¤ãƒ³", key="login_button"):
        if id_input in users and users[id_input] == pw_input:
            st.session_state.page = "main"
            st.session_state.user_id = id_input
            write_log(f"ãƒ­ã‚°ã‚¤ãƒ³: {id_input}")
            st.success(f"{id_input} ã•ã‚“ã€ã‚ˆã†ã“ãï¼")
            st.rerun()
        else:
            st.error("IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")

    st.markdown("---")
    if st.button("åˆå›ç™»éŒ²", key="to_register_button"):
        st.session_state.page = "register"
        st.rerun()

def register_page():
    st.title("ğŸ“ åˆå›ç™»éŒ²ãƒšãƒ¼ã‚¸")
    new_id = st.text_input("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", key="register_id_input")
    new_pw = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›", type="password", key="register_pw_input")

    if st.button("ç™»éŒ²", key="register_button"):
        if new_id in users:
            st.error("ã“ã®IDã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚")
        elif not new_id or not new_pw:
            st.error("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        else:
            users[new_id] = new_pw
            save_users(users)
            st.success("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚")
            st.session_state.page = "login"
            st.rerun()

    if st.button("ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹", key="to_login_button"):
        st.session_state.page = "login"
        st.rerun()

# ========== ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ ==========
def main_page():
    st.sidebar.write(f"ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {st.session_state.user_id}")
    if st.sidebar.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"):
        write_log(f"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ: {st.session_state.user_id}")
        st.session_state.page = "login"
        st.session_state.user_id = None
        st.warning("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚")
        st.rerun()

    st.title("ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨æ¡ä»¶è¨˜éŒ²ãƒ„ãƒ¼ãƒ«")

    # --- å…¥åŠ›ã‚¨ãƒªã‚¢ ---
    st.header("â‘  ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    program = st.file_uploader("Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆ.javaï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["java"], accept_multiple_files=True)
    testcase = st.file_uploader("ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆä»»æ„ï¼‰", type=["java"], accept_multiple_files=True)

    # --- æ¡ä»¶é¸æŠ ---
    st.header("â‘¡ æ¡ä»¶ã‚’é¸æŠ")
    test_opt = st.radio("ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æœ‰ç„¡", ["ã‚ã‚Š", "ãªã—"], horizontal=True)
    error_opt = st.selectbox("æŒ‡æ‘˜ã™ã‚‹ã‚¨ãƒ©ãƒ¼æ•°", ["ï¼‘ã¤ã ã‘", "ã§ãã‚‹ã ã‘ãŸãã•ã‚“", "æŒ‡å®šãªã—"])
    level_opt = st.radio("è§£èª¬ãƒ¬ãƒ™ãƒ«", ["åˆç´š", "ä¸­ç´š", "ä¸Šç´š"], horizontal=True)

    # --- ãƒ­ã‚°è¨˜éŒ²ãƒœã‚¿ãƒ³ ---
    if st.button("è¨˜éŒ²ã‚’ä¿å­˜"):
        if not program:
            st.error("Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
        else:
            program_names = [p.name for p in program]
            test_names = [t.name for t in testcase] if testcase else []

            # ãƒ•ã‚¡ã‚¤ãƒ«åã¨é¸æŠæ¡ä»¶ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
            log_path = os.path.join(LOG_DIR, f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{st.session_state.user_id}.txt")
            with open(log_path, "w", encoding="utf-8") as f:
                f.write(f"[ãƒ¦ãƒ¼ã‚¶ãƒ¼]: {st.session_state.user_id}\n")
                f.write(f"[æ—¥æ™‚]: {datetime.now()}\n")
                f.write("=== å…¥åŠ›æƒ…å ± ===\n")
                f.write(f"[ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ•ã‚¡ã‚¤ãƒ«]: {', '.join(program_names)}\n")
                f.write(f"[ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«]: {', '.join(test_names) or 'ãªã—'}\n")
                f.write(f"[ãƒ†ã‚¹ãƒˆæœ‰ç„¡]: {test_opt}\n")
                f.write(f"[ã‚¨ãƒ©ãƒ¼æ•°æŒ‡å®š]: {error_opt}\n")
                f.write(f"[è§£èª¬ãƒ¬ãƒ™ãƒ«]: {level_opt}\n")

            st.success("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æƒ…å ±ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¾ã—ãŸï¼")
            st.info(f"ä¿å­˜å…ˆ: {log_path}")

def view_logs_page():
    st.title("ğŸ“œ ãƒ­ã‚°é–²è¦§ãƒšãƒ¼ã‚¸")

    log_files = sorted(os.listdir(LOG_DIR))
    if not log_files:
        st.warning("ãƒ­ã‚°ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚")
        return

    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’é¸æŠ
    selected_log = st.selectbox("è¡¨ç¤ºã™ã‚‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ", log_files)

    if st.button("ãƒ­ã‚°ã‚’è¡¨ç¤º"):
        log_path = os.path.join(LOG_DIR, selected_log)
        with open(log_path, "r", encoding="utf-8") as f:
            content = f.read()
        st.text_area("ãƒ­ã‚°å†…å®¹", content, height=400)

    if st.sidebar.button("ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹"):
        st.session_state.page = "main"
        st.rerun()


# ========== ãƒšãƒ¼ã‚¸é·ç§»åˆ¶å¾¡ ==========
if st.session_state.page == "login":
    login_page()
elif st.session_state.page == "register":
    register_page()
elif st.session_state.page == "main":
    main_page()